{"version":3,"sources":["webpack:///./src/pages/blog/yaml-parser-from-scratch-zig.mdx"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"mappings":"8OAQaA,EAAe,GACtBC,EAAc,CAClBD,gBAEIE,EAAYC,IACH,SAASC,EAAT,GAGZ,IAFDC,EAEC,EAFDA,WACGC,EACF,8BACD,OAAO,YAACJ,EAAD,iBAAeD,EAAiBK,EAAhC,CAAuCD,WAAYA,EAAYE,QAAQ,cAG5E,qBAAG,kCAAMC,WAAW,KAAQ,CACxB,UAAa,4BACb,MAAS,CACP,SAAY,WACZ,QAAW,QACX,WAAc,OACd,YAAe,OACf,SAAY,WAPf,WAUC,+BAAGA,WAAW,QAAW,CACvB,UAAa,yBACb,KAAQ,4EACR,MAAS,CACP,QAAW,SAEb,OAAU,SACV,IAAO,aAPT,SASF,kCAAMA,WAAW,KAAQ,CACnB,UAAa,qCACb,MAAS,CACP,cAAiB,sBACjB,SAAY,WACZ,OAAU,IACV,KAAQ,IACR,gBAAmB,4WACnB,eAAkB,QAClB,QAAW,YAlBjB,OAqBJ,iCAAKA,WAAW,KAAQ,CAChB,UAAa,0BACb,IAAO,SACP,MAAS,SACT,IAAO,4EACP,OAAU,CAAC,iFAAkF,iFAAkF,kFAC/K,MAAS,kCACT,MAAS,CACP,MAAS,OACT,OAAU,OACV,OAAU,IACV,cAAiB,SACjB,SAAY,WACZ,IAAO,IACP,KAAQ,KAEV,QAAW,OACX,SAAY,WAtChB,QAVD,WAoDH,oYACA,kbACA,2TACA,grBACA,moBACA,qBAAG,kCAAMA,WAAW,KAAQ,CACxB,UAAa,4BACb,MAAS,CACP,SAAY,WACZ,QAAW,QACX,WAAc,OACd,YAAe,OACf,SAAY,WAPf,WAUC,+BAAGA,WAAW,QAAW,CACvB,UAAa,yBACb,KAAQ,+EACR,MAAS,CACP,QAAW,SAEb,OAAU,SACV,IAAO,aAPT,SASF,kCAAMA,WAAW,KAAQ,CACnB,UAAa,qCACb,MAAS,CACP,cAAiB,qBACjB,SAAY,WACZ,OAAU,IACV,KAAQ,IACR,gBAAmB,w/BACnB,eAAkB,QAClB,QAAW,YAlBjB,OAqBJ,iCAAKA,WAAW,KAAQ,CAChB,UAAa,0BACb,IAAO,mBACP,MAAS,mBACT,IAAO,+EACP,OAAU,CAAC,oFAAqF,oFAAqF,qFACrL,MAAS,kCACT,MAAS,CACP,MAAS,OACT,OAAU,OACV,OAAU,IACV,cAAiB,SACjB,SAAY,WACZ,IAAO,IACP,KAAQ,KAEV,QAAW,OACX,SAAY,WAtChB,QAVD,WAoDH,mmBACA,8fACA,0nBACA,+WACA,wLAKJJ,EAAWK,gBAAiB","file":"component---src-pages-blog-yaml-parser-from-scratch-zig-mdx-c6bc881d5a7666848b0f.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/vincent/Documents/Develop/Web/PersonalWebsite/website/src/components/layout-markdown.tsx\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"885px\"\n        }\n      }}>{`\n      `}<a parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-link\",\n          \"href\": \"/static/b6a426411a7b16bcafd9d465d44c9665/efc66/2025-02-11-yaml-banner.png\",\n          \"style\": {\n            \"display\": \"block\"\n          },\n          \"target\": \"_blank\",\n          \"rel\": \"noopener\"\n        }}>{`\n    `}<span parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-background-image\",\n            \"style\": {\n              \"paddingBottom\": \"56.333333333333336%\",\n              \"position\": \"relative\",\n              \"bottom\": \"0\",\n              \"left\": \"0\",\n              \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAqUlEQVQoz6WQRw7DMAwE85CIqiwqjpSCGPn/xyKXHJyjTBDEXma52ItPwTirQQ/MxSc8A4eTsNEAHYcB2HpnQHcHZ4xdd5urAqUW1813EwcYM4bSpL4f7f6q6dPyfMvPEueaa5Qambq5tc72F/2aI1zIsSBRFk6MicIkFClEDC1y14I+EQqGzP3aA0yT6N6XWgeWnEvaXahd/xbgL3bh8bZx4rXtQViG4S9c9lQ9zrcSqgAAAABJRU5ErkJggg==')\",\n              \"backgroundSize\": \"cover\",\n              \"display\": \"block\"\n            }\n          }}></span>{`\n  `}<img parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"alt\": \"Banner\",\n            \"title\": \"Banner\",\n            \"src\": \"/static/b6a426411a7b16bcafd9d465d44c9665/efc66/2025-02-11-yaml-banner.png\",\n            \"srcSet\": [\"/static/b6a426411a7b16bcafd9d465d44c9665/5a46d/2025-02-11-yaml-banner.png 300w\", \"/static/b6a426411a7b16bcafd9d465d44c9665/0a47e/2025-02-11-yaml-banner.png 600w\", \"/static/b6a426411a7b16bcafd9d465d44c9665/efc66/2025-02-11-yaml-banner.png 885w\"],\n            \"sizes\": \"(max-width: 885px) 100vw, 885px\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            },\n            \"loading\": \"lazy\",\n            \"decoding\": \"async\"\n          }}></img>{`\n  `}</a>{`\n    `}</span></p>\n    <p>{`I’m writing a software architecture visualization program in Zig that allows both developers and designer easily navigate a codebase and understand product functionality. Since it combines automatically generated data with human input, I needed a data format that was easy to generate from different languages, yet also easy to edit by hand. So, I went with YAML.`}</p>\n    <p>{`But, Zig is a new language and the various YAML parsers out there didn’t seem to do what I needed, mainly parsing of recursive data structures for the nested diagrams. Since this is a learning project and I was curious to experiment with different techniques to write parsers, I decided to write my own. Specifically, I wanted to see if I could make a zero-allocation parser and what its performance would be.`}</p>\n    <p>{`But did I really want to write a full YAML parser? Of course not! The advantage of writing things from scratch is that you know exactly what you need and can choose the trade-off between features and complexity/speed. So no crazy features and ‘yes’ and ‘no’ are strings, not boolean values.`}</p>\n    <p>{`There were 3 parts I needed to write: the generic YAML lexer, the generic YAML parser and the application-specific parser that turns the parsed YAML into the actual structs my application uses while running. The lexer divides the source file into chunks that are a bit easier to process. So { foo: 5 } would give the tokens “object_start, “whitespace”, “single_line_string”, “colon”, “whitespace”, “integer”, “whitespace” and “object_end”. What I wanted as an end result is “object_entry_start” (storing the start and end indices of “foo” in the source), “integer” and “object_entry_end”. The final high-level parser need to turn this into struct { foo: number }.`}</p>\n    <p>{`The lexer was pretty quick and fun to write. I store a pointer to the source and the start index of the next text to parse. Most of it was pretty simple, but I had the tendency to do too much in the lexer. I tried to skip comments in the lexer, but corrected that to do it in the parser. But, I actually kept track of how deep I am in arrays and objects, so I could differentiate between object keys and strings, which should’ve been the parser’s job. This introduced some needless complexity like keeping track of deep we’re nesting objects/arrays. But overall, most code looks like this and is pretty easy to follow.`}</p>\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"938px\"\n        }\n      }}>{`\n      `}<a parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-link\",\n          \"href\": \"/static/2b72f9c8d40f88fdf942abd6c8e915f4/dc333/2025-02-11-yaml-lexer-zig.png\",\n          \"style\": {\n            \"display\": \"block\"\n          },\n          \"target\": \"_blank\",\n          \"rel\": \"noopener\"\n        }}>{`\n    `}<span parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-background-image\",\n            \"style\": {\n              \"paddingBottom\": \"94.66666666666667%\",\n              \"position\": \"relative\",\n              \"bottom\": \"0\",\n              \"left\": \"0\",\n              \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACkklEQVQ4y2VUWa7bMAzMQRpb+75LtmXnJX0Butz/RqWdpM1DaUHgh6gZckY+EWmpraZkPzdVm5gKn6ts2dfMYlIuciOxUcQozDka0fgWp+F8Po/YSu+5laHZuti2mtKEYKOQI0LDOA6wo3GAo9++nd/ihDCG2xiXqW22zGm5TH1ZLlvvNc+LjskawymDA9IGYZyUkgtFGacYnxACLkhLF0K1dU39GloP0+pjVGniUsHVCGH0jGcyHvxPj5wDcll25H5pfZl35BLaopwzSjEKnxDWS22kFIQJxtizGG5Wyoc0u7al/gE1ae7aR99Wm5s0HhbjnDOOqHxR+IeMGBXBFT+voV9dmcJ8CWWG3cVonHN1MbFwRgkZhmGf8/CY9t4H3juhhLkwlX7ba1IVgqtYoSxOlzBtLmTN5RehXshQPuIRMUwl5aDIvoZjHZKASpCP/8WLNqPaRaoVjZ4FL5wmhGDKMOOE8eEtXpTfaENGKMvbvVzupbVca1o20Fz7IJSBesoFHKCUoqPHL8iEIMqZdFEoDWGsM85b54QQ43mgUoM9GKgkOCIMY/Is3mHBJApM0nSsMC2bJ5ebdd6kqlOV1ivjuRAUQ+FDqvEBeXowoWBA5Wzb8uUzztuuswsgT1q/h6n7VDhgAkFK91kcAcmTNqRMe1dXENmVAj37MqV5i1N3wN5ZsPdDFnRUjkffp4dZCBdA2Fdw9ZJbrS3HWmK/6ZAFeFJrMBg4dB8KvAwpMBWUoOe0tfY+VD9tcfnYX8W02ph1XZnUh+zDF2f9lWrf0Mhg0i67CvZeAc3V7jL8IWahQCEMV8Bj2I2E3iUfTkBCHRFgLP3a77+X249pu9XW6nqdr/f182f//LV83HNMWsn3+AO6nbJLZrD2hgAAAABJRU5ErkJggg==')\",\n              \"backgroundSize\": \"cover\",\n              \"display\": \"block\"\n            }\n          }}></span>{`\n  `}<img parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"alt\": \"Snippet of Lexer\",\n            \"title\": \"Snippet of Lexer\",\n            \"src\": \"/static/2b72f9c8d40f88fdf942abd6c8e915f4/dc333/2025-02-11-yaml-lexer-zig.png\",\n            \"srcSet\": [\"/static/2b72f9c8d40f88fdf942abd6c8e915f4/5a46d/2025-02-11-yaml-lexer-zig.png 300w\", \"/static/2b72f9c8d40f88fdf942abd6c8e915f4/0a47e/2025-02-11-yaml-lexer-zig.png 600w\", \"/static/2b72f9c8d40f88fdf942abd6c8e915f4/dc333/2025-02-11-yaml-lexer-zig.png 938w\"],\n            \"sizes\": \"(max-width: 938px) 100vw, 938px\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            },\n            \"loading\": \"lazy\",\n            \"decoding\": \"async\"\n          }}></img>{`\n  `}</a>{`\n    `}</span></p>\n    <p>{`Writing the parser however, was a different story. I shot myself in the foot with trying to it zero-allocation. This introduced a ton of edge cases to deal with. For example, when you encounter a new line in YAML, you might actually be closing multiple objects and arrays at the same time. But since we only return one token at a time, we need to remember whether you have any object/array closes. And there were a few things like that. It would’ve been simpler to use an arena allocator which makes allocation much cheaper and maybe even improved performance because of less branching.`}</p>\n    <p>{`The application-specific parsing was simple and fun again! Because the generic YAML parser doesn’t have any opinion on what you want to parse the data into, I could easily lay data out in a cache-friendly way. For example, instead of storing the tree as nested hash maps, I could use structs of arrays to store nodes in one linear array, their names in another one and when rendering them, I could just iterate iterate over the node array because they are already laid out depth-first.`}</p>\n    <p>{`Now, how performant is this? From my first tests, it parses at about 122mb/s using a ReleaseFast optimized build (not counting time spent reading from disk), which goes down to 96mb/s using ReleaseSafe and 27mb/s using Debug. Using ReleaseFast, my big, but simple stress test file of 123mb or 2,351,461 lines parses in just under a second, meaning 470,292 lines per second on my Intel i7-12700H CPU. But, how much faster could this be? That’s the whole reason I started this project, to be able to have a playground to reason about these kinds of questions, and get better at using the CPU at it’s full speed.`}</p>\n    <p>{`For now however, I’m busy playing around with other features like parsing a Typescript codebase to see if I can generate useful information (in YAML) about it’s architecture to visualize in this program. For those curious, the full parser is available as a Gist on GitHub `}{`[1]`}{`, but I don’t yet have time to turn it into a proper package.`}</p>\n    <p>{`Are you interested in this kind of stuff? Feel free to reach out, and I may perform and write about performance experiments that you can follow along with  :)`}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}